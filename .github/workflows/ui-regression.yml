name: UI Regression (Playwright Nightly)

on:
  schedule:
    - cron: "0 9 * * *" # 9:00 AM UTC daily = 1:00 AM PST daily
  workflow_dispatch:

jobs:
  regression_shards:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      fail-fast: false
      matrix:
        include:
          - shard: "1/3"
            shard_name: "1-of-3"
          - shard: "2/3"
            shard_name: "2-of-3"
          - shard: "3/3"
            shard_name: "3-of-3"

    # Bind this job to the GitHub Environment named "staging"
    environment: staging

    # Pull BASE_URL from environment vars and creds from environment secrets
    env:
      ENV: staging
      BASE_URL: ${{ vars.BASE_URL }}
      SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
      SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}
      SHARD: ${{ matrix.shard }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Prepare blob output dir
        run: rm -rf blob-report && mkdir -p blob-report

      - name: Lint (no warnings)
        run: npm run lint:strict

      # REQUIRED for tests that do: test.use({ auth: true })
      - name: Generate auth storageState
        run: npm run auth:state

      - name: Run Regression (sharded, blob report)
        run: |
          export PLAYWRIGHT_BLOB_OUTPUT_DIR="blob-report"
          npm run test:regression:shard:blob

      - name: Upload blob report (shard)
        uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: blob-report-${{ matrix.shard_name }}
          path: blob-report/
          retention-days: 14

  merge_report:
    runs-on: ubuntu-latest
    needs: regression_shards
    timeout-minutes: 30
    if: ${{ always() }}

    # merge job also needs access to repo tools (no secrets required here, but harmless)
    environment: staging

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download blob reports
        uses: actions/download-artifact@v7
        with:
          pattern: blob-report-*
          path: blob-report
          merge-multiple: true

      - name: Verify blob reports exist
        run: |
          ls -la blob-report
          test -n "$(ls -A blob-report)" || (echo "No blob reports found to merge" && exit 1)

      - name: Merge reports (single HTML)
        run: npm run report:merge:html

      - name: Upload merged HTML report
        uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: playwright-report-regression-merged
          path: playwright-report/
          retention-days: 14
