name: UI Regression (Playwright Nightly)

on:
  schedule:
    - cron: "0 9 * * *" # 9:00 AM UTC daily = 1:00 AM PST daily
  workflow_dispatch:

jobs:
  regression_shards:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      fail-fast: false
      matrix:
        include:
          - shard: "1/3"
            shard_name: "1-of-3"
          - shard: "2/3"
            shard_name: "2-of-3"
          - shard: "3/3"
            shard_name: "3-of-3"

    # Bind this job to the GitHub Environment named "staging"
    environment: staging

    # Pull BASE_URL from environment vars and creds from environment secrets
    env:
      ENV: staging
      BASE_URL: ${{ vars.BASE_URL }}
      SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
      SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}
      SHARD: ${{ matrix.shard }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Prepare blob output dir
        run: rm -rf blob-report && mkdir -p blob-report

      - name: Lint (no warnings)
        run: npm run lint:strict

      # REQUIRED for tests that do: test.use({ auth: true })
      - name: Generate auth storageState
        run: npm run auth:state

      - name: Run Regression (sharded, blob report)
        run: |
          export PLAYWRIGHT_BLOB_OUTPUT_DIR="blob-report"
          npm run test:regression:shard:blob

      - name: Upload blob report (shard)
        uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: blob-report-${{ matrix.shard_name }}
          path: blob-report/
          retention-days: 14

  merge_report:
    runs-on: ubuntu-latest
    needs: regression_shards
    timeout-minutes: 30
    if: ${{ always() }}

    # If your Grafana secrets/vars live in the "staging" Environment, keep this.
    environment: staging

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download blob reports
        uses: actions/download-artifact@v7
        with:
          pattern: blob-report-*
          path: blob-report
          merge-multiple: true

      - name: Verify blob reports exist
        run: |
          ls -la blob-report
          test -n "$(ls -A blob-report)" || (echo "No blob reports found to merge" && exit 1)

      - name: Merge reports (single HTML)
        run: npm run report:merge:html

      # ----------------------------
      # Grafana Cloud metrics (run-level) - nightly only, ONE metric per run
      # ----------------------------
      - name: Push run-level metrics to Grafana Cloud (nightly regression)
        if: ${{ github.event_name == 'schedule' }}
        env:
          OTLP_URL: ${{ secrets.GRAFANA_OTLP_METRICS_URL }}
          OTLP_AUTH_HEADER: ${{ secrets.GRAFANA_OTLP_AUTH_HEADER }}
          SERVICE_NAME: ${{ vars.SERVICE_NAME }}
          SHARDS_RESULT: ${{ needs.regression_shards.result }}
        shell: bash
        run: |
          : "${OTLP_URL:?Missing secret: GRAFANA_OTLP_METRICS_URL}"
          : "${OTLP_AUTH_HEADER:?Missing secret: GRAFANA_OTLP_AUTH_HEADER}"

          SERVICE_NAME="${SERVICE_NAME:-playwright-saucedemo}"
          NOW_NS=$(date +%s%N)

          # success | failure | cancelled
          STATUS="${SHARDS_RESULT:-unknown}"

          cat > otlp-metrics.json <<'JSON'
          {
            "resourceMetrics": [
              {
                "resource": {
                  "attributes": [
                    { "key": "service.name", "value": { "stringValue": "__SERVICE__" } },
                    { "key": "repo", "value": { "stringValue": "__REPO__" } }
                  ]
                },
                "scopeMetrics": [
                  {
                    "scope": { "name": "ui-tests" },
                    "metrics": [
                      {
                        "name": "ui_run_total",
                        "description": "Total UI nightly runs",
                        "unit": "1",
                        "sum": {
                          "aggregationTemporality": 2,
                          "isMonotonic": true,
                          "dataPoints": [
                            {
                              "asInt": 1,
                              "timeUnixNano": "__NOW_NS__",
                              "attributes": [
                                { "key": "workflow", "value": { "stringValue": "__WORKFLOW__" } },
                                { "key": "job", "value": { "stringValue": "regression-nightly" } },
                                { "key": "event", "value": { "stringValue": "__EVENT__" } },
                                { "key": "ref", "value": { "stringValue": "__REF__" } },
                                { "key": "status", "value": { "stringValue": "__STATUS__" } }
                              ]
                            }
                          ]
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
          JSON

          sed -i.bak \
            -e "s|__SERVICE__|${SERVICE_NAME}|g" \
            -e "s|__REPO__|${GITHUB_REPOSITORY}|g" \
            -e "s|__NOW_NS__|${NOW_NS}|g" \
            -e "s|__WORKFLOW__|${GITHUB_WORKFLOW}|g" \
            -e "s|__EVENT__|${GITHUB_EVENT_NAME}|g" \
            -e "s|__REF__|${GITHUB_REF_NAME}|g" \
            -e "s|__STATUS__|${STATUS}|g" \
            otlp-metrics.json

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "$OTLP_AUTH_HEADER" \
            "$OTLP_URL" \
            --data-binary @otlp-metrics.json

      - name: Upload merged HTML report
        uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: playwright-report-regression-merged
          path: playwright-report/
          retention-days: 14
