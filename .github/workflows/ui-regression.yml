name: UI Regression (Playwright Nightly)

on:
  schedule:
    - cron: "0 9 * * *" # 9:00 AM UTC daily = 1:00 AM PST daily
  workflow_dispatch:

jobs:
  regression_shards:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      fail-fast: false
      matrix:
        include:
          - shard: "1/3"
            shard_name: "1-of-3"
          - shard: "2/3"
            shard_name: "2-of-3"
          - shard: "3/3"
            shard_name: "3-of-3"

    # Use Environment secrets/vars for test credentials + base URL
    environment: staging

    env:
      ENV: staging
      BASE_URL: ${{ vars.BASE_URL }}
      SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
      SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}
      SHARD: ${{ matrix.shard }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Prepare blob output dir
        run: rm -rf blob-report && mkdir -p blob-report

      - name: Lint (no warnings)
        run: npm run lint:strict

      # REQUIRED for tests that do: test.use({ auth: true })
      - name: Generate auth storageState
        run: npm run auth:state

      - name: Run Regression (sharded, blob report)
        run: |
          export PLAYWRIGHT_BLOB_OUTPUT_DIR="blob-report"
          npm run test:regression:shard:blob

      - name: Upload blob report (shard)
        uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: blob-report-${{ matrix.shard_name }}
          path: blob-report/
          retention-days: 14

  merge_report:
    runs-on: ubuntu-latest
    needs: regression_shards
    timeout-minutes: 30
    if: ${{ always() }}

    # Read Actions run metadata via GitHub API
    permissions:
      actions: read
      contents: read

    # NO environment binding here (we want env secrets separate)

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download blob reports
        uses: actions/download-artifact@v7
        with:
          pattern: blob-report-*
          path: blob-report
          merge-multiple: true

      - name: Verify blob reports exist
        run: |
          ls -la blob-report
          test -n "$(ls -A blob-report)" || (echo "No blob reports found to merge" && exit 1)

      - name: Merge reports (single HTML)
        run: npm run report:merge:html

      - name: Upload merged HTML report
        uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: playwright-report-regression-merged
          path: playwright-report/
          retention-days: 14

      # ----------------------------
      # Run-level metadata (duration/status)
      # ----------------------------
      - name: Compute run-level metadata (duration/status) from GitHub API
        id: runmeta
        if: ${{ always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.runId;

            const { data: run } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id,
            });

            const started = run.run_started_at ? new Date(run.run_started_at) : null;
            const updated = run.updated_at ? new Date(run.updated_at) : null;

            const durationSeconds =
              started && updated ? Math.max(0, Math.round((updated - started) / 1000)) : 0;

            core.setOutput("duration_seconds", String(durationSeconds));
            core.setOutput("status", run.conclusion || run.status || "unknown");

      # ----------------------------
      # Push metrics to Grafana Cloud (repo secrets only)
      # ----------------------------
      - name: Push run-level metrics to Grafana Cloud (OTLP HTTP)
        if: ${{ always() }}
        env:
          GRAFANA_OTLP_METRICS_URL: ${{ secrets.GRAFANA_OTLP_METRICS_URL }}
          GRAFANA_OTLP_USERNAME: ${{ secrets.GRAFANA_OTLP_USERNAME }}
          GRAFANA_OTLP_TOKEN: ${{ secrets.GRAFANA_OTLP_TOKEN }}

          METRIC_REPO: ${{ github.repository }}
          METRIC_WORKFLOW: ${{ github.workflow }}
          METRIC_BRANCH: ${{ github.ref_name }}
          METRIC_RUN_ID: ${{ github.run_id }}
          METRIC_RUN_ATTEMPT: ${{ github.run_attempt }}
          METRIC_SHA: ${{ github.sha }}

          METRIC_STATUS: ${{ steps.runmeta.outputs.status }}
          METRIC_DURATION_SECONDS: ${{ steps.runmeta.outputs.duration_seconds }}
        run: npm run metrics:push

      # ----------------------------
      # Slack notify (nightly regression only)
      # Secrets:
      #  - SLACK_WEBHOOK_URL
      #  - GRAFANA_DASHBOARD_PUBLIC_URL (or store as repo variable and change to vars.*)
      # ----------------------------
      - name: Notify Slack (nightly regression)
        if: ${{ always() }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GRAFANA_DASHBOARD_URL: ${{ secrets.GRAFANA_DASHBOARD_PUBLIC_URL }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          STATUS: ${{ steps.runmeta.outputs.status }}
          DURATION_SECONDS: ${{ steps.runmeta.outputs.duration_seconds }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail

          case "${STATUS}" in
            success) emoji="‚úÖ" ;;
            failure) emoji="‚ùå" ;;
            cancelled) emoji="üö´" ;;
            skipped) emoji="‚è≠Ô∏è" ;;
            timed_out) emoji="‚è±Ô∏è" ;;
            *) emoji="‚ö†Ô∏è" ;;
          esac

          dur="${DURATION_SECONDS:-0}"
          mins=$((dur / 60))
          secs=$((dur % 60))
          pretty="${mins}m ${secs}s"

          report_hint="Playwright report: open Run ‚Üí Artifacts ‚Üí playwright-report-regression-merged"

          payload=$(cat <<EOF
          {
            "text": "${emoji} UI Regression Nightly ‚Äî ${STATUS}\n‚Ä¢ Repo: ${REPO}\n‚Ä¢ Branch: ${BRANCH}\n‚Ä¢ Duration: ${pretty}\n‚Ä¢ Run: ${RUN_URL}\n‚Ä¢ Grafana: ${GRAFANA_DASHBOARD_URL}\n‚Ä¢ ${report_hint}"
          }
          EOF
          )

          curl -sS -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL" >/dev/null

          echo "Slack notification sent"
