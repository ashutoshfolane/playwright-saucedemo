name: UI Regression (Playwright Nightly)

on:
  schedule:
    - cron: "0 9 * * *" # 9:00 AM UTC daily = 1:00 AM PST daily
  workflow_dispatch:

jobs:
  regression_shards:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      fail-fast: false
      matrix:
        include:
          - shard: "1/3"
            shard_name: "1-of-3"
          - shard: "2/3"
            shard_name: "2-of-3"
          - shard: "3/3"
            shard_name: "3-of-3"

    # Use Environment secrets/vars for test credentials + base URL
    environment: staging

    env:
      ENV: staging
      BASE_URL: ${{ vars.BASE_URL }}
      SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
      SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}
      SHARD: ${{ matrix.shard }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Prepare blob output dir
        run: rm -rf blob-report && mkdir -p blob-report

      - name: Lint (no warnings)
        run: npm run lint:strict

      # REQUIRED for tests that do: test.use({ auth: true })
      - name: Generate auth storageState
        run: npm run auth:state

      - name: Run Regression (sharded, blob report)
        run: |
          export PLAYWRIGHT_BLOB_OUTPUT_DIR="blob-report"
          npm run test:regression:shard:blob

      - name: Upload blob report (shard)
        uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: blob-report-${{ matrix.shard_name }}
          path: blob-report/
          retention-days: 14

  merge_report:
    runs-on: ubuntu-latest
    needs: regression_shards
    timeout-minutes: 30
    if: ${{ always() }}

    # This job needs to read Actions run metadata (start/end) via GitHub API
    permissions:
      actions: read
      contents: read

    # Environment secrets/vars NOT needed here (only merging reports + pushing metrics)

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download blob reports
        uses: actions/download-artifact@v7
        with:
          pattern: blob-report-*
          path: blob-report
          merge-multiple: true

      - name: Verify blob reports exist
        run: |
          ls -la blob-report
          test -n "$(ls -A blob-report)" || (echo "No blob reports found to merge" && exit 1)

      - name: Merge reports (single HTML)
        run: npm run report:merge:html

      - name: Upload merged HTML report
        uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: playwright-report-regression-merged
          path: playwright-report/
          retention-days: 14

      # ----------------------------
      # Run-level metrics (ONLY nightly regression)
      # Repo secrets stay as Repository secrets (not Environment secrets)
      # ----------------------------
      - name: Compute run-level metadata (duration/status) from GitHub API
        id: runmeta
        if: ${{ always() }}
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          json="$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "${api}")"

          started_at="$(node -e "const j=${json@Q}; const o=JSON.parse(j.slice(1,-1)); console.log(o.run_started_at || '')")"
          updated_at="$(node -e "const j=${json@Q}; const o=JSON.parse(j.slice(1,-1)); console.log(o.updated_at || '')")"
          conclusion="$(node -e "const j=${json@Q}; const o=JSON.parse(j.slice(1,-1)); console.log(o.conclusion || 'unknown')")"

          # compute duration seconds (best-effort)
          duration="$(node - <<'NODE'
          const started = process.env.STARTED;
          const updated = process.env.UPDATED;
          function toMs(s){ return s ? Date.parse(s) : NaN; }
          const ms = toMs(updated) - toMs(started);
          const sec = Number.isFinite(ms) && ms > 0 ? Math.round(ms/1000) : 0;
          console.log(sec);
          NODE
          )" STARTED="$started_at" UPDATED="$updated_at"

          echo "started_at=$started_at" >> "$GITHUB_OUTPUT"
          echo "updated_at=$updated_at" >> "$GITHUB_OUTPUT"
          echo "conclusion=$conclusion" >> "$GITHUB_OUTPUT"
          echo "duration_seconds=$duration" >> "$GITHUB_OUTPUT"

      - name: Push run-level metrics to Grafana Cloud (OTLP HTTP)
        if: ${{ always() }}
        env:
          # Repo secrets (NOT Environment secrets)
          GRAFANA_OTLP_METRICS_URL: ${{ secrets.GRAFANA_OTLP_METRICS_URL }}
          GRAFANA_OTLP_USERNAME: ${{ secrets.GRAFANA_OTLP_USERNAME }}
          GRAFANA_OTLP_TOKEN: ${{ secrets.GRAFANA_OTLP_TOKEN }}

          # Metadata for labels
          METRIC_REPO: ${{ github.repository }}
          METRIC_WORKFLOW: ${{ github.workflow }}
          METRIC_BRANCH: ${{ github.ref_name }}
          METRIC_RUN_ID: ${{ github.run_id }}
          METRIC_RUN_ATTEMPT: ${{ github.run_attempt }}
          METRIC_SHA: ${{ github.sha }}

          METRIC_STATUS: ${{ steps.runmeta.outputs.conclusion }}
          METRIC_DURATION_SECONDS: ${{ steps.runmeta.outputs.duration_seconds }}
        run: npm run metrics:push
